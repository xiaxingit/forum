#set($layout="view/back/common/layout/common_layout.htm")
<style>
.default_image_div{
    width:80px;
    padding:2px;
    border:1px solid #ccc;
    float:left;
    margin:1px;
}
.default_image_div:hover{
background-color:#f60;
cursor: pointer;
}
.default_image{
    height:80px;
    width:80px;
}
</style>
<!-- 表单 begin -->
<form id="form1" action="$request.getContextPath()/sysmanage/userManage.html" style="display:none;">
  <input type="text" name="currPage" id="currPage" value="$!page"/>
  <input type="text" name="msg" id="msg" value=""/>
</form>
<!-- 表单 end -->
<!-- 新增/编辑  用户信息  begin -->
<div id="edit_user_model" class="modal hide in" style="margin-left:-500px;width:800px;display: none;" aria-hidden="true" data-backdrop="static">
 <div class="modal-header">
    <button class="close" type="button" data-dismiss="modal" id="close_user_model"></button>
    <h4>
                   编辑用户
    </h4>
</div>
<div class="modal-body">
<form id="user_from_1" action="$request.getContextPath()/sysmanage/addUserInfo.html" method="post" class="form-horizontal form-row-seperated">
   <table class="table table-bordered">
      <tr>
      <td>  
	    用户名
	 </td>
	 <td>
    <input id="user_id" name="user_id" style="display:none;" type="text"/>
    <input id="status" name="status" style="display:none;" type="text"/>
    <input id="last_login_time" name="last_login_time" style="display:none;" type="text"/>
    <input  class="m-wrap" type="text" value="" size="18" style="height:30px;" id="user_name" name="user_name"></input>
	  </td>
	  <td>
	 姓名 
	  </td>
	  <td>
	  <input  class="m-wrap" type="text" value="" size="18" style="height:30px;" id="name" name="name"></input>
	  </td>
      </tr>
      <tr>
      <td>
	     性别        
	  </td>
	  <td> 
           <input type="radio" value="男" checked="checked" name="gender"></input>
		           男
           <input type="radio" value="女" name="gender"></input>
		           女
		    
      </td>
      <td>
                   所在地址 
      </td>
      <td>
       <input  class="m-wrap" type="text" value="" size="18" style="height:30px;" id="address" name="address"></input>
      </td>
      </tr>
      <tr>
      <td>
	      出生日期</td>
	      <td>
	        <input type="text" class="Wdate" onClick="WdatePicker()" id="birthday" name="birthday" style="height:30px;" />
      </td>
      <td>
                  工作行业   </td><td><input  class="m-wrap" type="text" value="" size="18" style="height:30px;" id="industry" name="industry"></input>
      </td>
      </tr>
      <tr>
      <td>
	    所在职位  </td><td> <input  class="m-wrap" type="text" value="" size="18" style="height:30px;" id="position" name="position"></input>
      </td>
      <td>
                  签名   </td><td><input  class="m-wrap" type="text" value="" size="18" style="height:30px;" id="autograph" name="autograph"></input>
      </td>
      </tr>
      <tr>
      <td>
   		头像  </td><td>
   		<div class="input-append">
   		 <input id="hide_head_image" name="head_image" style="display:none;" type="text"/>
   		 <input  class="m-wrap" type="text" value="default_hpic.png" disabled="" style="width:150px;height:34px;" id="head_image" ></input>
   		 <div class="btn-group">
   		      <a class="btn" data-toggle="modal" href="#sel_hi_model" >选择</a>
   		 </div>
   		</div>
   		
      </td>
      <td>
                   手机号  </td><td> <input  class="m-wrap" type="text" value="" size="18" style="height:30px;" id="phone" name="phone"></input>
      </td>
      </tr>
       <tr>
      <td>
                     邮箱 </td><td>   <div class="input-icon left">
			    <i class="icon-envelope"></i>
			    <input class="m-wrap " type="text" placeholder="" style="height:33px;" id="email" name="email"></input>
			</div>
      </td>
      <td>
                      标签  </td><td> <input  class="m-wrap" type="text" value="" size="18" style="height:30px;" id="label" name="label"></input>
      </td>
      </tr>
      </table>
</form>
</div>
<div class="modal-footer" style="text-align:center;">
    <a href="javascript:ok_add();" id="okAdd" class="btn blue" ><i class="icon-ok"></i>确定新增</a>
    <a href="javascript:ok_edit();" id="okEdit" class="btn blue" style="display:none;"><i class="icon-ok"></i>确定修改</a>
    <a href="javascript:hide_edit_user_div()" class="btn blue" ><i class="icon-remove"></i>取消</a>
</div>
</div>
<!-- 新增/编辑   用户信息 end -->
<!-- 是否删除 确认框  begin -->
<div id="isdel_model" class="modal hide in" style="display: none;"  aria-hidden="true" data-backdrop="static">
 <div class="modal-header">
    <button class="close" type="button" data-dismiss="modal" id="close_del_model"></button>
    <h4>
                    系统提示
    </h4>
</div>
<div class="modal-body">
   <p style="font-size:18px;">
            确定删除吗？
   </p>
   </div>
   <div class="modal-footer" style="text-align:center;">
       <a href="javascript:ok_dele();" class="btn blue" ><i class="icon-ok"></i>确定删除</a>
       <a href="javascript:hide_dele_div()" class="btn blue" ><i class="icon-remove"></i>取消</a>
   </div>
</div>
<!-- 是否删除 确认框  end -->
<!-- 是初始化密码 确认框  begin -->
<div id="initpwd_model" class="modal hide in" style="display: none;"  aria-hidden="true" data-backdrop="static">
 <div class="modal-header">
    <button class="close" type="button" data-dismiss="modal" id="close_initpwd_model"></button>
    <h4>
                    系统提示
    </h4>
</div>
<div class="modal-body">
   <p style="font-size:18px;">
            确定初始化密码吗？
   </p>
   </div>
   <div class="modal-footer" style="text-align:center;">
       <a href="javascript:initial_pwd();" class="btn blue" ><i class="icon-ok"></i>确定</a>
       <a data-toggle="modal" href="#initpwd_model" class="btn blue" ><i class="icon-remove"></i>取消</a>
   </div>
</div>
<!-- 是否初始化密码 确认框  end -->
<!-- 选择头像  begin -->
<div id="sel_hi_model" class="modal hide in" style="display: none;"  aria-hidden="true" data-backdrop="static">
 <div class="modal-header">
    <button class="close" type="button" data-dismiss="modal" id="close_hi_model"></button>
    <h4>
                    选择头像
    </h4>
</div>
<div class="modal-body">
	  <div class="fileupload fileupload-new" data-provides="fileupload">
	    <div class="fileupload-new thumbnail" style="width: 200px; height: 150px;">
	        <img id="h_img_show" alt="" src="$request.getContextPath()/userHeadImage/default_hpic.png" ></img>
	    </div>
	    <div class="fileupload-preview fileupload-exists thumbnail" style="max-width: 200px; max-height: 150px; line-height: 20px;"></div>
	    <div >
	        <span class="btn btn-file">
	            <span class="fileupload-new">
                                                         上传图片
	            </span>
	            <span class="fileupload-exists">
               		 重选
	            </span>
	            <input class="default" type="file"></input>
	        </span>
	        <a class="btn fileupload-exists" data-dismiss="fileupload" href="#">
	            	移除
	        </a>
	    </div>
	 </div>
	 <hr />
	 <div class="default_image_div"><img alt="系统头像1" onclick="toHimgShow(this)" src="$request.getContextPath()/userHeadImage/default_1.png" class="default_image"></div>
	 <div class="default_image_div"><img alt="系统头像2" onclick="toHimgShow(this)" src="$request.getContextPath()/userHeadImage/default_2.png" class="default_image"></div>
	 <div class="default_image_div"><img alt="系统头像3" onclick="toHimgShow(this)" src="$request.getContextPath()/userHeadImage/default_3.png" class="default_image"></div>
	 <div class="default_image_div"><img alt="系统头像4" onclick="toHimgShow(this)" src="$request.getContextPath()/userHeadImage/default_4.png" class="default_image"></div>
	 <div class="default_image_div"><img alt="系统头像5" onclick="toHimgShow(this)" src="$request.getContextPath()/userHeadImage/default_5.png" class="default_image"></div>
	 <div class="default_image_div"><img alt="系统头像6" onclick="toHimgShow(this)" src="$request.getContextPath()/userHeadImage/default_6.png" class="default_image"></div>
 </div>
   <div class="modal-footer" style="text-align:center;">
       <a data-toggle="modal" href="#sel_hi_model" onclick="ok_selhi()" class="btn blue" ><i class="icon-ok"></i>确定</a>
   </div>
</div>
<!-- 选择头像  end -->
<!-- 选择角色  begin -->
<div id="sel_role_model" class="modal hide in" style="display: none;"  aria-hidden="true" data-backdrop="static">
 <div class="modal-header">
    <button class="close" type="button" data-dismiss="modal" id="close_role_model"></button>
    <h4>
            选择角色
    </h4>
</div>
<div class="modal-body" id="sel_role_div">
   
</div>
<div class="modal-footer" style="text-align:center;">
    <a data-toggle="modal" href="#sel_role_model" onclick="changeRole()" class="btn blue" ><i class="icon-ok"></i>确定</a>
    <a data-toggle="modal" href="#sel_role_model" class="btn blue" ><i class="icon-remove"></i>取消</a>
</div>
</div>

<!-- 选择角色  end -->
 <div class="portlet box" style="margin:0px;">
    <div class="portlet-body fuelux">
     #if($msg)
	    <div class="alert alert-success">
	    <button class="close" data-dismiss="alert"></button>
	    <strong>
	       $msg
	    </strong>
		</div>
     #end
      <a id="add_role_btn" class='btn blue' data-toggle="modal" href="#edit_user_model" type='button'><i class="icon-plus"></i>新增用户</a>
      <table class="table table-striped table-bordered  table-hover">
        <thead>
         <tr>
            <th>序号</th><th>用户名</th><th>姓名</th><th>角色</th><th>性别</th><th>手机号</th><th>邮箱</th><th>状态</th><th style="width:12%;">最后登录时间</th><th style="width:26%;">操作</th>
         </tr>
        </thead>
        <tbody id="table_body">
           #foreach($u in $userList)
           <tr>
           <td>
           #set($no=($page - 1) * $size + $velocityCount)
           $no</td>
           <td>$!u.user_name</td>
           <td>$!u.name</td>
           <td>$!u.userRole</td>
           <td>$!u.gender</td>
           <td>$!u.phone</td>
           <td>$!u.email</td>
           <td>
           #if($!u.status == 1)
            <span class='label label-success'>正常</span>
           #else
            <span class='label label-important'>禁用</span> 
           #end
           </td>
           <td>$!u.last_login_time.substring(0,$!u.last_login_time.indexOf('.'))</td>
           <td>
           #if($!u.status == 1)
           <button onclick='change_en($u.user_id,0)' class='btn red' type='button'><i class="icon-lock"></i>禁用</button>
           #else
           <button onclick='change_en($u.user_id,1)' class='btn green' type='button'><i class="icon-unlock"></i>启用</button>
           #end
           &nbsp;<a class='btn' data-toggle="modal" href="#edit_user_model" onclick='edit($u.user_id)' type='button'><i class="icon-pencil"></i>编辑</a>
           &nbsp;<a class='btn purple' data-toggle='modal' href='#isdel_model' onclick='bj_del($u.user_id)' type='button'><i class="icon-trash"></i>删除</a>
           &nbsp;<a class='btn blue' data-toggle="modal" href="#sel_role_model" onclick='bj_selrole($u.user_id)' type='button'><i class="icon-user"></i>角色</a>
           &nbsp;<a class='btn yellow' data-toggle="modal" href="#initpwd_model" onclick='bj_initial_pwd($u.user_id)' type='button'><i class="icon-repeat"></i>初始化密码</a>
           </td>
           </tr>
           #end
        </tbody>
      </table>
      #if($userList)
      #if($userList.size() > 0 )
         #parse("view/back/common/layout/pagination.htm")
      #end
	  #end
    </div>
</div>
<script>
$(document).ready(function(){
	
	   $("#role_sel").select2();
	   
	   $(".form_datetime").datetimepicker({
           format: "yyyy-MM-dd",
           pickerPosition: (App.isRTL() ? "bottom-right" : "bottom-left")
       });

	
	
});
var del_user_id = 0;
var init_user_id = 0;
var role_user_id = 0;
/**
 * 分页查询 跳转页
 */
function fycx(index){
	$("#currPage").val(index);
	$("#form1").submit();
}
/**
 * 标记删除的用户id
 */
function bj_del(id){
	del_user_id = id;
}
/**
 * 确认删除
 */
function ok_dele(){
	$.ajax({
        type: "POST",
        url: "$request.getContextPath()/sysmanage/delUserById.html",
        data: {del_user_id:del_user_id},
        async: false,
        success: function(data) {
        	hide_dele_div();
        	$("#msg").val("2");
        	$("#form1").submit();
        },
        error: function(request) {
        }
    });
}
/**
 * 隐藏确认删除框
 */
function hide_dele_div(){
	$("#close_del_model").trigger("click");
}
/**
 * 确认新增用户
 */
function ok_add(){
	$("#hide_head_image").val($("#head_image").val());
	$("#user_from_1").submit();
}
/**
 * 系统默认图片放到显示框
 */
function toHimgShow(obj){
	$("#h_img_show").attr("src",obj.src);
}
/**
 * 确认选择头像
 */
function ok_selhi(){
	var img = $(".fileupload-preview").children()[0];
	if(img!= null && typeof(img)!='undefined'){
		$("#head_image").val(img.src);
	}else{
		var src = $("#h_img_show").attr("src");
		src = src.substr(src.lastIndexOf('/')+1,src.length);
		$("#head_image").val(src);
	}
	
}
function bj_initial_pwd(user_id){
	init_user_id = user_id;
}

/**
 * 初始化密码
 */
function initial_pwd(){
	$.ajax({
        type: "POST",
        url: "$request.getContextPath()/sysmanage/initialPwd.html",
        data: {user_id:init_user_id},
        async: false,
        success: function(data) {
        	if(data == "1"){
        	$("#form1").submit();
        	}
        },
        error: function(request) {
        }
    });
}
/**
 * 启用/禁用
 */
function change_en(user_id,status){
	$.ajax({
        type: "POST",
        url: "$request.getContextPath()/sysmanage/changeUserStatus.html",
        data: {user_id:user_id,status:status},
        async: false,
        success: function(data) {
        	$("#form1").submit();
        },
        error: function(request) {
        }
    });
}
/**
 * 编辑用户
 */
function edit(edit_uid){
	 #foreach($u in $userList)
	    var uid = $u.user_id;
	    if(uid == edit_uid){
	    	$("#user_id").val(uid);
	    	$("#status").val("$!u.status");
	    	$("#last_login_time").val("$!u.last_login_time");
	    	$("#user_name").val("$!u.user_name");
	    	$("#name").val("$!u.name");
	    	$('input:radio[name=gender][value=$u.gender]').attr("checked",true); 
	    	$("#address").val("$!u.address");
	    	$("#birthday").val("$!u.birthday");
	    	$("#industry").val("$!u.industry");
	    	$("#position").val("$!u.position");
	    	$("#autograph").val("$!u.autograph");
	    	$("#hide_head_image").val("$!u.head_image");
	    	$("#head_image").val("$!u.head_image");
	    	if("$!u.head_image" == "" || "$!u.head_image" == null){
	    		$("#h_img_show").attr("src","$request.getContextPath()/userHeadImage/default_hpic.png");
	    	}else{
	    		$("#h_img_show").attr("src","$request.getContextPath()/userHeadImage/$u.head_image");
	    	}
	    	$("#phone").val("$!u.phone");
	    	$("#email").val("$!u.email");
	    	$("#label").val("$!u.label");
	    	$("#okAdd").hide();
	    	$("#okEdit").show();
	    }
	 #end
}
/**
 * 隐藏用户编辑框
 */
function hide_edit_user_div(){
	$("#user_id").val("");
	$("#status").val("");
	$("#last_login_time").val("");
	$("#user_name").val("");
	$("#name").val("");
	$('input:radio[name=gender][value=男]').attr("checked",true); 
	$("#address").val("");
	$("#birthday").val("");
	$("#industry").val("");
	$("#position").val("");
	$("#autograph").val("");
	$("#hide_head_image").val("default_hpic.png");
	$("#head_image").val("default_hpic.png");
	$("#h_img_show").attr("src","$request.getContextPath()/userHeadImage/default_hpic.png");
	$("#phone").val("");
	$("#email").val("");
	$("#label").val(""); 
	$("#okAdd").show();
	$("#okEdit").hide();
	$("#close_user_model").trigger("click");
}
/**
 * 确定修改
 */
function ok_edit(){
	$("#hide_head_image").val($("#head_image").val());
	$.ajax({
        type: "POST",
        url: "$request.getContextPath()/sysmanage/updateUser.html",
        data: $("#user_from_1").serialize(),
        async: false,
        success: function(data) {
        	if(data == "1"){
        	hide_edit_user_div();
        	$("#form1").submit();
        	}
        },
        error: function(request) {
        }
    });
}
/**
 * 标记 选择角色的 用户ID
 */
function bj_selrole(uid){
	role_user_id = uid;
	$.ajax({
        type: "POST",
        url: "$request.getContextPath()/sysmanage/getRoleList.html",
        async: false,
        success: function(data) {
        	sel_ur_checkbox(data);
        },
        error: function(request) {
        }
    });
}
function sel_ur_checkbox(all_data){
	$.ajax({
        type: "POST",
        url: "$request.getContextPath()/sysmanage/getUserRoleList.html",
        data:{user_id:role_user_id},
        async: false,
        success: function(data) {
        	var html = "";
        	$.each(all_data, function(index,all_obj){
        		var checked = "";
        		$.each(data, function(i,user_obj){  
        		  if(all_obj.role_id == user_obj.role_id){
        			  checked = 'checked="true"';
        		  }
        		});
        		//	<label for="checkboxFiveInput"></label>
        		 html += '<div class="checkboxFive"><input id="rcbox_'+all_obj.role_id+'" '+checked+' type="checkbox" value="'+
                 all_obj.role_id+'" name="role_arr" ></input><label for="rcbox_'+all_obj.role_id+'"></label></div><div style="float:left;font-size:18px;">'
                 +all_obj.role_name+'</div>';
        	});
        	$("#sel_role_div").html(html);
        },
        error: function(request) {
        }
    });
}
/**
 * 修改角色
 */
function changeRole(){
	var arr = "";
	$("input:checkbox[name='role_arr']:checked").each(function(){
		arr += $(this).val()+",";
	});
	arr = arr.substr(0,arr.length-1);
	$.ajax({
        type: "POST",
        url: "$request.getContextPath()/sysmanage/updateUserRole.html",
        data:{user_id:role_user_id,roleids:arr},
        async: false,
        success: function(data) {
        	if(data == "1"){
        		$("#form1").submit();
        	}
        },
        error: function(request) {
        }
    });
}
</script>